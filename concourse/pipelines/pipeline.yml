groups:
- name: all
  jobs:
  - compile_gpdb_centos6
  - icw_gporca_centos6
## ======================================================================
## resource types
## ======================================================================

# resource_types:
# - name: terraform
#   type: docker-image
#   source:
#     repository: ljfranklin/terraform-resource

## ======================================================================
## resources
## ======================================================================

resources:
# - name: ccp_src
#   type: git
#   source:
#     branch: {{ccp-git-branch}}
#     private_key: {{ccp-git-key}}
#     uri: {{ccp-git-remote}}
#     tag_filter: 1.0.0-beta.1

# - name: terraform
#   type: terraform
#   source:
#     env:
#       AWS_ACCESS_KEY_ID: {{tf-machine-access-key-id}}
#       AWS_SECRET_ACCESS_KEY: {{tf-machine-secret-access-key}}
#     storage:
#       access_key_id: {{tf-machine-access-key-id}}
#       secret_access_key: {{tf-machine-secret-access-key}}
#       region_name: {{aws-region}}
#       # This is not parameterized, on purpose. All tfstates will go to this spot,
#       # and different teams will place there clusters' tfstate files under different paths
#       bucket: gpdb5-pipeline-dynamic-terraform
#       ###########################################################
#       # Two conventions are allowed for bucket_path:            #
#       # 1) Cluster are expected to be destroyed automatically   #
#       #    Toolsmiths will reap old and orphaned clusters       #
#       #                                                         #
#       #      bucket_path: prod/[Pipeline Name]/                 #
#       #                                                         #
#       # 2) Long lived clusters for development.                 #
#       #    The team that creates it is responsible for cluster  #
#       #                                                         #
#       #     bucket_path: dev/[Team Name]/                       #
#       #                                                         #
#       ###########################################################
#       bucket_path: {{tf-bucket-path}}

- name: gpdb_src
  type: git
  source:
    branch: pipeline/postgis
    uri: https://github.com/njayaram2/gpdb.git
    ignore_paths:
    - gpdb-doc/*
    - README*

- name: gpaddon_src
  type: git
  source:
    branch: {{gpaddon-git-branch}}
    private_key: {{gpaddon-git-key}}
    uri: {{gpaddon-git-remote}}

- name: pxf_src
  type: git
  source:
    branch: {{pxf-git-branch}}
    private_key: {{pxf-git-key}}
    uri: {{pxf-git-remote}}

- name: centos-gpdb-dev-6
  type: docker-image
  source:
    repository: pivotaldata/centos-gpdb-dev
    tag: '6-gcc6.2-llvm3.7'

- name: bin_gpdb_centos6
  type: s3
  source:
    access_key_id: {{bucket-access-key-id}}
    bucket: {{bucket-name}}
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    versioned_file: {{bin_gpdb_centos_versioned_file}}

- name: reduced-frequency-trigger
  type: time
  source:
    location: America/Los_Angeles
    days: [Sunday, Monday, Tuesday, Wednesday, Thursday, Friday]
    start: {{reduced-frequency-trigger-start}}
    stop: {{reduced-frequency-trigger-stop}}

## ======================================================================
## reusable anchors
## ======================================================================
# ccp_create_params_anchor: &ccp_default_params
#   action: create
#   delete_on_failure: true
#   generate_random_name: true
#   terraform_source: ccp_src/aws/

# ccp_vars_anchor: &ccp_default_vars
#   aws_instance-node-instance_type: t2.medium
#   platform: centos6

# ccp_destroy_anchor: &ccp_destroy
#   put: terraform
#   params:
#     action: destroy
#     env_name_file: terraform/name
#     terraform_source: ccp_src/aws/
#     vars:
#       aws_instance-node-instance_type: t2.micro #t2.micro is ignored in destroy, but aws_instance-node-instance_type is required.
#   get_params:
#     action: destroy

# debug_sleep_anchor: &debug_sleep
#   do:
#   - task: debug_sleep
#     config:
#       platform: linux
#       image_resource:
#         type: docker-image
#         source:
#           repository: alpine
#           tag: latest
#       run:
#         path: 'sh'
#         args: ['-c', 'sleep 6h']
#     ensure:
#       <<: *ccp_destroy

## ======================================================================
## jobs
## ======================================================================

# Stage 1: Build and C Unit Tests

jobs:

- name: compile_gpdb_centos6
  plan:
  - aggregate:
    - get: reduced-frequency-trigger
      trigger: {{reduced-frequency-trigger-flag}}
    - get: gpdb_src
      trigger: {{gpdb_src-trigger-flag}}
    - get: gpaddon_src
    - get: pxf_src
      trigger: true
    - get: centos-gpdb-dev-6
  - task: compile_gpdb
    file: gpdb_src/concourse/tasks/compile_gpdb.yml
    image: centos-gpdb-dev-6
    params:
      IVYREPO_HOST: {{ivyrepo_host}}
      IVYREPO_REALM: {{ivyrepo_realm}}
      IVYREPO_USER: {{ivyrepo_user}}
      IVYREPO_PASSWD: {{ivyrepo_passwd}}
      CONFIGURE_FLAGS: {{configure_flags}}
      TARGET_OS: centos
      TARGET_OS_VERSION: 6
      BLD_TARGETS: "clients loaders"
  - aggregate:
    - put: bin_gpdb_centos6
      params:
        file: gpdb_artifacts/bin_gpdb.tar.gz
    - put: installer_rhel6_gpdb_clients
      params:
        file: gpdb_artifacts/greenplum-clients-*-rhel6-x86_64.zip
    - put: installer_rhel6_gpdb_loaders
      params:
        file: gpdb_artifacts/greenplum-loaders-*-rhel6-x86_64.zip

- name: icw_gporca_centos6
  plan:
  - aggregate:
    - get: gpdb_src
      passed: [compile_gpdb_centos6]
    - get: bin_gpdb
      resource: bin_gpdb_centos6
      passed: [compile_gpdb_centos6]
      trigger: true
    - get: centos-gpdb-dev-6
  - task: ic_gpdb
    file: gpdb_src/concourse/tasks/ic_gpdb.yml
    image: centos-gpdb-dev-6
    params:
      MAKE_TEST_COMMAND: PGOPTIONS='-c optimizer=on' installcheck-world
      BLDWRAP_POSTGRES_CONF_ADDONS: "fsync=off"
      TEST_OS: centos
      CONFIGURE_FLAGS: {{configure_flags}}